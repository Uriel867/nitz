events {}


http {
  resolver 127.0.0.11 ipv6=off;

  # upstream group name backend
  upstream backend_api {
    zone backend_servers 64k; # shared memory area
    server api:8080 resolve; # routes to application:8080 and resolves container names
    keepalive 32;
  }

    # Rate limiting zones (these remain the same)
    limit_req_zone $binary_remote_addr zone=api_key_small_limiter:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=api_key_big_limiter:10m rate=50r/m;
    limit_req_zone $binary_remote_addr zone=account_by_id_limiter:10m rate=2000r/m;
    limit_req_zone $binary_remote_addr zone=account_by_puuid_limiter:10m rate=1000r/m;
    limit_req_zone $binary_remote_addr zone=match_by_match_id_limiter:10m rate=200r/s;
    limit_req_zone $binary_remote_addr zone=match_by_puuid_limiter:10m rate=200r/s;
    limit_req_zone $binary_remote_addr zone=match_timeline_by_match_id_limiter:10m rate=200r/s;

    server {
        listen 80;

        location /account/by-id/ {
            limit_req zone=account_by_id_limiter burst=1000  ;
            limit_req zone=api_key_small_limiter burst=20 ;
            limit_req zone=api_key_big_limiter burst=50 ;
            proxy_pass http://backend_api;
        }

        location /account/by-puuid/ {
            limit_req zone=account_by_puuid_limiter burst=1000 ;
            limit_req zone=api_key_small_limiter burst=20 ;
            limit_req zone=api_key_big_limiter burst=50 ;
            proxy_pass http://backend_api;

        }

        location /match/by-match-id/ {
            limit_req zone=match_by_match_id_limiter burst=200 ;
            limit_req zone=api_key_small_limiter burst=20 ;
            limit_req zone=api_key_big_limiter burst=50 ;
            proxy_pass http://backend_api;

        }

        location /match/timeline/by-match-id/ {
            limit_req zone=match_timeline_by_match_id_limiter burst=200 ;
            limit_req zone=api_key_small_limiter burst=20 ;
            limit_req zone=api_key_big_limiter burst=50 ;
            proxy_pass http://backend_api;

        }

        location /match/by-puuid/ {
            limit_req zone=match_by_puuid_limiter burst=200 ;
            limit_req zone=api_key_small_limiter burst=20 ;
            limit_req zone=api_key_big_limiter burst=50 ;
            proxy_pass http://backend_api;
        }

        location / {
            proxy_pass http://backend_api;
        }
    }
}